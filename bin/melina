#!/usr/bin/env bun

import { mkdir, writeFile, stat } from "fs/promises";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const currentDir = process.cwd();

function serverTs() {
    return `import { start } from 'melina';
import path from 'path';

const appDir = path.join(import.meta.dir, 'app');

await start({
  port: parseInt(process.env.PORT || "3000"),
  appDir,
  defaultTitle: 'My App',
});
`;
}

function layoutTsx() {
    return `import React from 'react';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>My App</title>
      </head>
      <body>
        <main>{children}</main>
      </body>
    </html>
  );
}
`;
}

function pageTsx() {
    return `import React from 'react';

export default function HomePage() {
  return (
    <div style={{ maxWidth: '600px', margin: '60px auto', fontFamily: 'system-ui, sans-serif' }}>
      <h1>Hello Melina! </h1>
      <p>Edit <code>app/page.tsx</code> to get started.</p>
      <div id="counter-root" />
    </div>
  );
}
`;
}

function pageClientTsx() {
    return `export default function mount(): () => void {
  const root = document.getElementById('counter-root');
  if (!root) return () => {};

  let count = 0;

  const btn = <button
    style={{
      padding: '8px 20px',
      fontSize: '16px',
      borderRadius: '8px',
      border: '1px solid #ccc',
      cursor: 'pointer',
    }}
    onClick={() => {
      count++;
      btn.textContent = \`Count: \${count}\`;
    }}
  >Count: 0</button>;

  root.appendChild(btn);

  return () => {
    root.innerHTML = '';
  };
}
`;
}

function tsconfigJson() {
    return `{
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "react",
    "strict": true,
    "target": "esnext",
    "module": "esnext",
    "moduleResolution": "bundler",
    "types": ["bun-types"]
  }
}
`;
}

function packageJson(name: string) {
    return `{
  "name": "${name}",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "bun run server.ts"
  },
  "dependencies": {
    "melina": "latest"
  },
  "devDependencies": {
    "@types/bun": "latest"
  }
}
`;
}

async function main() {
    const args = process.argv.slice(2);
    const [command, projectName] = args;

    // Handle "melina start" command for app router
    if (command === "start") {
        console.log(" Starting Melina app router...");

        const appDir = join(currentDir, "app");
        try {
            await stat(appDir);
        } catch (error) {
            console.error(`Error: No "app" directory found in current directory.`);
            console.log(`\nCreate an app directory with pages:`);
            console.log(`  app/page.tsx          -> /`);
            console.log(`  app/about/page.tsx    -> /about`);
            console.log(`  app/blog/[id]/page.tsx -> /blog/:id`);
            process.exit(1);
        }

        const { serve, createAppRouter } = await import("../src/web.ts");

        const port = parseInt(process.env.PORT || "3000", 10);

        await serve(createAppRouter({
            appDir,
        }), { port });

        return;
    }

    // Handle "melina init <project-name>" command
    if (command !== "init" || !projectName || projectName === "-h" || projectName === "--help") {
        console.log("Melina.js CLI ");
        console.log("\nUsage:");
        console.log("  melina init <project-name>  Create a new project");
        console.log("  melina start                Start app router dev server");
        console.log("\nExamples:");
        console.log("  npx melina init my-app");
        console.log("  npx melina start");
        return;
    }

    const projectPath = join(currentDir, projectName);

    try {
        await stat(projectPath);
        console.error(`Error: Directory "${projectName}" already exists`);
        process.exit(1);
    } catch (error) {
        // Directory doesn't exist, which is what we want
    }

    try {
        await mkdir(join(projectPath, "app"), { recursive: true });

        await writeFile(join(projectPath, "server.ts"), serverTs());
        await writeFile(join(projectPath, "app", "layout.tsx"), layoutTsx());
        await writeFile(join(projectPath, "app", "page.tsx"), pageTsx());
        await writeFile(join(projectPath, "app", "page.client.tsx"), pageClientTsx());
        await writeFile(join(projectPath, "tsconfig.json"), tsconfigJson());
        await writeFile(join(projectPath, "package.json"), packageJson(projectName));

        console.log(`\n Created project "${projectName}"\n`);
        console.log(`  cd ${projectName}`);
        console.log(`  bun install`);
        console.log(`  bun run dev\n`);
    } catch (error) {
        console.error(`Error creating project: ${error}`);
        process.exit(1);
    }
}

main();