#!/usr/bin/env bun

import { mkdir, copyFile, readdir, stat } from "fs/promises";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const templatePath = join(__dirname, "..", "examples", "vanilla");
const currentDir = process.cwd();

async function copyDirectory(src: string, dest: string) {
    const entries = await readdir(src, { withFileTypes: true });
    
    for (const entry of entries) {
        const srcPath = join(src, entry.name);
        const destPath = join(dest, entry.name);
        
        if (entry.isDirectory()) {
            await mkdir(destPath, { recursive: true });
            await copyDirectory(srcPath, destPath);
        } else {
            await copyFile(srcPath, destPath);
        }
    }
}

async function main() {
    const args = process.argv.slice(2);
    const [command, projectName] = args;
    
    // Handle "melina start" command for app router
    if (command === "start") {
        console.log("ü¶ä Starting Melina app router...");
        
        // Check if app directory exists
        const appDir = join(currentDir, "app");
        try {
            await stat(appDir);
        } catch (error) {
            console.error(`Error: No "app" directory found in current directory.`);
            console.log(`\nCreate an app directory with pages:`);
            console.log(`  app/page.tsx          -> /`);
            console.log(`  app/about/page.tsx    -> /about`);
            console.log(`  app/blog/[id]/page.tsx -> /blog/:id`);
            process.exit(1);
        }
        
        // Start the development server
        const { serve, createAppRouter } = await import("../src/web.ts");
        
        const port = parseInt(process.env.PORT || "3000", 10);
        
        await serve(createAppRouter({
            appDir,
        }), { port });
        
        return;
    }
    
    // Handle "melina init <project-name>" command
    if (command !== "init" || !projectName || projectName === "-h" || projectName === "--help") {
        console.log("Melina.js CLI");
        console.log("\nUsage:");
        console.log("  melina init <project-name>  Create a new project");
        console.log("  melina start                Start app router development server");
        console.log("\nExamples:");
        console.log("  melina init my-new-project");
        console.log("  melina start");
        return;
    }
    
    const projectPath = join(currentDir, projectName);
    
    try {
        await stat(projectPath);
        console.error(`Error: Directory "${projectName}" already exists`);
        process.exit(1);
    } catch (error) {
        // Directory doesn't exist, which is what we want
    }
    
    try {
        await mkdir(projectPath, { recursive: true });
        await copyDirectory(templatePath, projectPath);
        
        console.log(`‚úÖ Successfully created project "${projectName}"`);
        console.log(`üìÅ Navigate to your project: cd ${projectName}`);
        console.log(`üöÄ Run your project: bun run index.ts`);
    } catch (error) {
        console.error(`Error creating project: ${error}`);
        process.exit(1);
    }
}

main();